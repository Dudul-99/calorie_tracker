{% extends 'tracker/base.html' %}

{% block content %}
<h2>Calorie Summary for {{ date }}</h2>

<form method="get">
    <label for="date">Select Date:</label>
    <input type="date" id="date" name="date" value="{{ date|date:'Y-m-d' }}">
    <button type="submit">View Summary</button>
</form>

<h3>Daily Calorie Objective: {{ daily_objective|default:"Not set" }}</h3>
{% if progress is not None %}
    <p>Progress: {{ progress|floatformat:1 }}% of daily objective</p>
    <progress value="{{ total_nutrients.calories }}" max="{{ daily_objective }}"></progress>
{% endif %}

<h3>Total Nutrients:</h3>
<p>Calories: {{ total_nutrients.calories|floatformat:2 }} / {{ daily_objective|default:"N/A" }}</p>
<p>Carbohydrates: {{ total_nutrients.carbs|floatformat:2 }}g</p>
<p>Fats: {{ total_nutrients.fats|floatformat:2 }}g</p>
<p>Proteins: {{ total_nutrients.proteins|floatformat:2 }}g</p>

<div>
    <h3>7-Day Nutrient Overview</h3>
    <canvas id="nutrientChart" width="400" height="200"></canvas>
</div>

<div>
    <h3>Macronutrient Breakdown</h3>
    <canvas id="macroChart" width="200" height="200"></canvas>
</div>

<h3>Intakes:</h3>
<ul>
{% for intake in intakes %}
    <li>
        {{ intake.datetime|time:"H:i" }} - {{ intake.food.name }}
        ({{ intake.quantity }}{% if intake.food.is_liquid %}ml{% else %}g{% endif %})
        <br>
        Calories: {{ intake.calculate_nutrients.calories|floatformat:2 }},
        Carbs: {{ intake.calculate_nutrients.carbs|floatformat:2 }}g,
        Fats: {{ intake.calculate_nutrients.fats|floatformat:2 }}g,
        Proteins: {{ intake.calculate_nutrients.proteins|floatformat:2 }}g
    </li>
{% empty %}
    <li>No intakes recorded for this day.</li>
{% endfor %}
</ul>

<a href="{% url 'tracker:add_intake' %}">Add New Intake</a>

<script>
    // Nutrient Overview Chart
    var ctx = document.getElementById('nutrientChart').getContext('2d');
    var nutrientChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ chart_data.labels|safe }},
            datasets: [{
                label: 'Calories',
                data: {{ chart_data.calories|safe }},
                borderColor: 'rgb(255, 99, 132)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Macronutrient Breakdown Chart
    var macroCtx = document.getElementById('macroChart').getContext('2d');
    var macroChart = new Chart(macroCtx, {
        type: 'pie',
        data: {
            labels: ['Carbs', 'Fats', 'Proteins'],
            datasets: [{
                data: [
                    {{ total_nutrients.carbs|default:0 }},
                    {{ total_nutrients.fats|default:0 }},
                    {{ total_nutrients.proteins|default:0 }}
                ],
                backgroundColor: [
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 205, 86)'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Macronutrient Breakdown'
                }
            }
        }
    });
</script>
{% endblock %}